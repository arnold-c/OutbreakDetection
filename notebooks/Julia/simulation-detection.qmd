---
title: "Outbreak Threshold Detection"
author: "Callum Arnold"
date: today
title-block-banner: true
format:
  html:
    theme: flatly
    toc: true
    toc-depth: 4
    code-copy: true
    code-fold: true
    code-overflow: wrap
    code-tools: true
    code-link: true
    anchor-sections: true
    fig-width: 10
    fig-height: 8
execute:
  cache: true
jupyter: julia-1.8
---

```{julia}
using DrWatson
quickactivate(@__DIR__, "OutbreakDetection")
```

```{julia}
using JumpProcesses, StochasticDiffEq, DifferentialEquations, LinearAlgebra
using Catalyst, Random, Statistics, DataFrames, CairoMakie, ProgressMeter

CairoMakie.activate!()
```

```{julia}
function rate(out, u, p, t)
    out[1] = p[1] * u[1] * u[2] / u[4]      # β * X * Y / N
    out[2] = p[2] * u[2]                    # ν * Y
    out[3] = p[3] * u[4]                    # μ * N
    out[4] = p[3] * u[1]                    # μ * X
    out[5] = p[3] * u[2]                    # μ * Y
    out[6] = p[3] * u[3]                    # μ * Z
    nothing
end
```

```{julia}
c = zeros(4, 6)
# X + Y --> Y
c[1, 1] = -1        # X -> X - 1
c[2, 1] = 1         # Y -> Y + 1

# Y --> Z
c[2, 2] = -1        # Y -> Y - 1
c[3, 2] = 1         # Z -> Z + 1

# X --> 2X
c[1, 3] = 1         # X -> X + 1
c[4, 3] = 1         # N -> N + 1

# X --> 0X
c[1, 4] = -1        # X -> X - 1
c[4, 4] = -1        # N -> N - 1

# Y --> 0Y
c[2, 5] = -1        # Y -> Y - 1
c[4, 5] = -1        # N -> N - 1

# Z --> 0Z
c[3, 6] = -1        # Z -> Z - 1
c[4, 6] = -1        # N -> N - 1

function change!(du, u, p, t, counts, mark)
    mul!(du, c, counts)
    nothing
end
```

```{julia}
rj = RegularJump(rate, change!, 6)
```

```{julia}
tmax = 250.0
δt = 0.001
tspan = (0.0, tmax)
tlength = length(tspan[1]:δt:tspan[2])
Random.seed!(1234);
```

```{julia}
R₀ = 16
γ = 1/8
μ = 1 / (365 * 62.5)
β = R₀ * (γ + μ)
p = (β, γ, μ)

u₀ = [800, 20, 800, NaN]
u₀[4] = sum(u₀[1:3])
```

```{julia}
prob = DiscreteProblem(u₀, tspan, p)
jump_prob = JumpProblem(prob, Direct(), rj)
sol = solve(jump_prob, TauLeaping(); dt = δt)
sol_array = zeros(5, length(sol))
sol_array[1:4, :] = Array(sol)
sol_array[5, :] = sum(sol_array[1:3, :], dims = 1);

sol_array[4, :] == sol_array[5, :]
```

```{julia}
f = Figure()
ax = Axis(
    f[1, 1],
    xlabel = "Time",
    ylabel = "Number"
)

lines!(ax, sol.t, sol_array[1, :], linewidth = 3, label = "X(t)")
lines!(ax, sol.t, sol_array[2, :], linewidth = 3, label = "Y(t)")
lines!(ax, sol.t, sol_array[3, :], linewidth = 3, label = "Z(t)")
lines!(ax, sol.t, sol_array[4, :], linewidth = 3, label = "N(t) jump")
lines!(ax, sol.t, sol_array[5, :], linewidth = 3, label = "N(t) calc")

axislegend(ax)

f
```

```{julia}
function run_sir_sim(; u₀, tspan, p)
    prob = DiscreteProblem(u₀, tspan, p)
    jump_prob = JumpProblem(prob, Direct(), rj)
    sol_jump = solve(jump_prob, TauLeaping(); dt = δt)
    return sol_jump(0:δt:tmax);
end
```

```{julia}
function create_sim_array(; out_jump)
    test_array[1:3, :] = Array(out_jump)
    test_array[4, :] .= out_jump.t

    return test_array
end
```

```{julia}
sir_sim_plot = Figure()
ax = Axis(sir_sim_plot[1, 1],
    xlabel = "Time",
    ylabel = "Number"
)

nsims = 100

sir_array = zeros(Float64, 4, tlength)
all_sims_array = zeros(Float64, 4, tlength, nsims)
sim_means = zeros(Float64, 3, tlength)

@showprogress for i in 1:nsims
    out_jump = run_sir_sim(u₀ = u₀, tspan = tspan, p = p)
    sir_array = create_sim_array(out_jump = out_jump)

    all_sims_array[:, :, i] = sir_array


    lines!(ax, sir_array[4, :], sir_array[1, :], linewidth = 4, color = ("dodgerblue4", 0.01))
    lines!(ax, sir_array[4, :], sir_array[2, :], linewidth = 4, color = ("firebrick3", 0.01))
    lines!(ax, sir_array[4, :], sir_array[3, :], linewidth = 4, color = ("chocolate2", 0.01)) 
    
end

@showprogress for sim in 1:tlength, outcome in 1:3
    sim_means[outcome, sim] = mean(all_sims_array[outcome, sim, :])
end

lines!(ax, sir_array[4, :], sim_means[1, :], linewidth = 3, color = "dodgerblue4")
lines!(ax, sir_array[4, :], sim_means[2, :], linewidth = 3, color = "firebrick3")
lines!(ax, sir_array[4, :], sim_means[3, :], linewidth = 3, color = "chocolate2")

sir_sim_plot
```
